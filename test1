import pandas as pd, math, json
from pathlib import Path
from config import CLEAN_FILE

df = pd.read_csv(CLEAN_FILE)

# 1) Sanity checks généraux
print("Colonnes:", sorted(df.columns))
print("n lignes:", len(df))
print("Saisons distinctes:", df["season"].nunique() if "season" in df else "—")
print("Plage dates:", (df["date"].min(), df["date"].max()) if "date" in df else "—")

# 2) Unicité match (si clés dispo)
keys = [c for c in ["game_id","date","home_team","away_team"] if c in df.columns]
if keys:
    print("Clé utilisée pour unicité:", keys)
    print("Doublons potentiels:", df.duplicated(subset=keys).sum())

# après lecture du CSV dans test1
keys = [c for c in ["date", "home_team", "away_team"] if c in df.columns]
if keys:
    df = df.drop_duplicates(subset=keys, keep="first")

# 3) Moyenne & IC95% de home_diff
if "home_diff" not in df.columns and {"home_pts","away_pts"}.issubset(df.columns):
    df["home_diff"] = df["home_pts"] - df["away_pts"]
m = df["home_diff"].mean()
sd = df["home_diff"].std(ddof=1)
n = df["home_diff"].notna().sum()
ci = (m - 1.96*sd/math.sqrt(n), m + 1.96*sd/math.sqrt(n))
print(f"home_diff mean={m:.2f}, IC95%=[{ci[0]:.2f},{ci[1]:.2f}], n={n}")

# 4) Le résiduel devrait ~ égaler b0 en moyenne si residual_margin = home_diff - alpha*elo_diff
s = json.loads(Path("data/cleaned/summary.json").read_text())
b0 = s["elo_linear"]["b0"]
alpha = s["elo_linear"]["alpha"]
if "elo_diff" in df.columns:
    r = df["home_diff"] - alpha*df["elo_diff"]
    print(f"mean(residual proxy)={r.mean():.2f} vs b0={b0:.2f}")

# 5) Corrélation résiduel vs altitude & Δ altitude
import numpy as np
y = df["residual_margin"] if "residual_margin" in df else (df["home_diff"] - alpha*df["elo_diff"])
for col in ["elev_m","delta_elev"]:
    if col in df.columns:
        sub = df[[col]].join(y).dropna()
        corr = np.corrcoef(sub[col], sub[y.name])[0,1]
        print(f"corr({y.name},{col}) = {corr:.3f}, n={len(sub)}")

dups = df[df.duplicated(subset=["date","home_team","away_team"], keep=False)] \
        .sort_values(["date","home_team","away_team"])

diag = dups.groupby(["date","home_team","away_team"]).agg(
    n=("season","size"),
    n_arena=("arena","nunique"),
    n_lat=("lat","nunique"),
    n_lon=("lon","nunique"),
).sort_values("n", ascending=False).head(10)
print(diag)

